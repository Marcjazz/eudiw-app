name: Compile and Deploy

on:
  push:
    branches:
      - develop  # Replace 'main' with your main branch name or any other branch name you want to trigger this workflow

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: eudiw-app  # Set the path to your repository

      - name: Install dependencies and build
        working-directory: ./eudiw-app  # Change directory to your repository
        run: |
          npm ci
          npx nx build wallet-react --baseHref=/eudiw-web/

      - name: Check if deploy branch exists
        working-directory: ./eudiw-app  # Change directory to your repository
        run: |
          if ! git show-ref --quiet refs/heads/deploy; then
            git checkout -b deploy
            git push -u origin deploy
          else
            git fetch origin deploy:deploy
            git checkout deploy
          fi

      - name: Remove all files except dist
        run: |
          shopt -s extglob
          rm -rf !(.git|dist)

      - name: Deploy to eudiw-web repository
        run: |
          mv dist/apps/* ./
          git add .
          git commit -m "Deploy compiled code to eudiw-web"
          git push --force origin deploy



# jobs:
#   build:
#     # Recommended if you intend to make multiple deployments in quick succession.
#     concurrency: ci-${{ github.ref }}
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout 🛎️
#         uses: actions/checkout@v4
#         # This example project is built using npm and outputs the result to the 'build' folder.
#         # Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
#       - name: Install and Build 🔧
#         run: |
#           npm ci
#           npx nx run wallet-react:build --baseHref=/eudiw-app-dev/

#       - name: Setup Pages 📄🔧
#         id: pages
#         uses: actions/configure-pages@v4
#       - name: Upload artifact
#         uses: actions/upload-pages-artifact@v3
#         with:
#           path: ./dist/apps/wallet-react
#   deploy:
#     environment:
#       name: github-pages
#       url: ${{ steps.deployment.outputs.page_url }}
#     runs-on: ubuntu-latest
#     needs: build
#     steps:
#       - name: Set deployment directory
#         id: set-deploy-dir
#         run: echo "deploy_dir=${{ github.ref_slug }}" >> $GITHUB_ENV
#       - name: Deploy to Github Pages 🚀
#         id: deployment
#         uses: actions/deploy-pages@v4
#         with:
#             branch: ${{ env.deploy_dir }}
#             folder: dist/apps/wallet-react
