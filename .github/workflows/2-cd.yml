name: Build and Deploy

on:
  push:
    branches:
      - main
      - develop

jobs:
  build_and_upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Get branch name
        id: branch_name
        run: |
          echo "branch_name=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_ENV

      - name: Install dependencies and build for main
        run: |
          npm ci
          npx nx build wallet-react --baseHref=/eudiw-app/
          mkdir -p compiled_code/${branch_name}
          mv dist/apps/wallet-react/* compiled_code/${branch_name}

      - name: Upload compiled code
        uses: actions/upload-artifact@v2
        with:
          name: new-eudiw-artifact
          path: compiled_code/

  merge_artifact:
    needs: build_and_upload
    runs-on: ubuntu-latest

    steps:
      - name: Download existing compiled code
        uses: actions/download-artifact@v2
        with:
          name: new-eudiw-artifact
          path: compiled_code
          
      - name: Download existing compiled code
        id: download_existing
        uses: actions/download-artifact@v2
        with:
          name: eudiw-artifact
          path: existing_compiled_code

      - name: Merge existing and new compiled code
        if: steps.download_existing.outputs.artifact_size != '0 B'
        run: |
          cp -r existing_compiled_code/. compiled_code/
          rm -rf existing_compiled_code

      - name: Re-upload merged compiled code
        if: ${{ always() }}
        uses: actions/upload-artifact@v2
        with:
          name: eudiw-artifact
          path: compiled_code/

